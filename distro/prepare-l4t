ubuntu_packages=" 
symlinks 
libpthread-stubs0-dev 
libffi-dev 
libexpat1-dev 
x11proto-gl-dev 
x11proto-dri2-dev 
x11proto-dri3-dev 
x11proto-present-dev 
libx11-dev 
libxext-dev 
libxdamage-dev 
libxfixes-dev 
libx11-xcb-dev 
libxcb-dri2-0-dev 
libxcb-dri3-dev 
libxcb-present-dev 
libxcb-sync-dev 
libxcb-glx0-dev 
libxshmfence-dev 
libxxf86vm-dev 
libmtdev-dev 
libxcb-composite0-dev 
libxcursor-dev 
libcairo2-dev 
libxkbcommon-dev 
libjpeg-dev 
libpam0g-dev 
libwayland-dev 
libdbus-1-dev 
libpixman-1-dev 
libsystemd-login-dev 
libevdev-dev 
" 
 
status "Using qemu to install required packages on target FS..." 
run_in_qemu /usr/bin/apt-get update 
run_in_qemu /usr/bin/apt-get -y install $ubuntu_packages 
# Installing libudev-dev might upgrade udev, which will fail because upstart is not running. 
# Install it independently and forcibly to avoid this. 
if ! run_in_qemu /usr/bin/dpkg-query -l libudev-dev |grep '^ii' >/dev/null; then 
    run_in_qemu /usr/bin/apt-get download libudev-dev 
    run_in_qemu /usr/bin/dpkg --force-depends -i $(basename $SYSROOT/home/libudev-dev*.deb) 
    rm -f $SYSROOT/libudev-dev*.deb 
    status "You might have to run 'apt-get -f install' to fix packages dependencies on the next boot" 
fi 

status "Fixing symlinks in target FS' /usr/lib/..."
LINKS=$(find $SYSROOT/usr/lib -type l -not -path "*/usr/lib/modules/*")
for LINK in $LINKS; do
    L=$(readlink $LINK)
    if [[ "$L" = /* ]]; then
        ABS="${SYSROOT}${L}"
        echo Fixing $LINK...
        rm -f $LINK
        ln -sfr $ABS $LINK
    fi
done

status "Updating X server path in /etc/X11..."
find $SYSROOT/etc/X11 -type f -exec sed -i 's/\/usr\/bin\/X\b/\/opt\/nouveau\/bin\/X/g' {} +
